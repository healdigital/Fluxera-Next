name: E2E Test Report

on:
  workflow_run:
    workflows: ['E2E Tests']
    types:
      - completed

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  report:
    name: Post Test Results
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion != 'cancelled'

    steps:
      - name: Download test results
        uses: actions/download-artifact@v4
        with:
          name: playwright-report
          path: playwright-report
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Download test JSON results
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: playwright-report
          path: test-results
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Parse test results
        id: test-results
        run: |
          if [ -f "test-results/test-results.json" ]; then
            TOTAL=$(jq '.suites | map(.specs | length) | add' test-results/test-results.json)
            PASSED=$(jq '[.suites[].specs[].tests[] | select(.status == "expected")] | length' test-results/test-results.json)
            FAILED=$(jq '[.suites[].specs[].tests[] | select(.status == "unexpected")] | length' test-results/test-results.json)
            SKIPPED=$(jq '[.suites[].specs[].tests[] | select(.status == "skipped")] | length' test-results/test-results.json)
            
            echo "total=$TOTAL" >> $GITHUB_OUTPUT
            echo "passed=$PASSED" >> $GITHUB_OUTPUT
            echo "failed=$FAILED" >> $GITHUB_OUTPUT
            echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
          else
            echo "total=0" >> $GITHUB_OUTPUT
            echo "passed=0" >> $GITHUB_OUTPUT
            echo "failed=0" >> $GITHUB_OUTPUT
            echo "skipped=0" >> $GITHUB_OUTPUT
          fi

      - name: Find PR number
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${context.payload.workflow_run.head_branch}`,
            });
            
            if (pullRequests.length > 0) {
              return pullRequests[0].number;
            }
            return null;

      - name: Comment on PR
        if: steps.pr.outputs.result != 'null'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr.outputs.result }};
            const conclusion = '${{ github.event.workflow_run.conclusion }}';
            const total = '${{ steps.test-results.outputs.total }}';
            const passed = '${{ steps.test-results.outputs.passed }}';
            const failed = '${{ steps.test-results.outputs.failed }}';
            const skipped = '${{ steps.test-results.outputs.skipped }}';
            
            const statusEmoji = conclusion === 'success' ? '✅' : '❌';
            const statusText = conclusion === 'success' ? 'passed' : 'failed';
            
            const body = `## ${statusEmoji} E2E Test Results
            
            **Status:** ${statusText}
            
            | Metric | Count |
            |--------|-------|
            | Total Tests | ${total} |
            | ✅ Passed | ${passed} |
            | ❌ Failed | ${failed} |
            | ⏭️ Skipped | ${skipped} |
            
            ${failed > 0 ? '### Failed Tests\n\nPlease check the [test report](${{ github.event.workflow_run.html_url }}) for details.' : ''}
            
            <details>
            <summary>View full report</summary>
            
            [View Playwright HTML Report](${{ github.event.workflow_run.html_url }})
            
            </details>
            `;
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('E2E Test Results')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body,
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body,
              });
            }

      - name: Create check run
        uses: actions/github-script@v7
        with:
          script: |
            const conclusion = '${{ github.event.workflow_run.conclusion }}';
            const passed = '${{ steps.test-results.outputs.passed }}';
            const failed = '${{ steps.test-results.outputs.failed }}';
            
            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'E2E Test Results',
              head_sha: '${{ github.event.workflow_run.head_sha }}',
              status: 'completed',
              conclusion: conclusion,
              output: {
                title: `${passed} passed, ${failed} failed`,
                summary: `E2E tests ${conclusion === 'success' ? 'passed' : 'failed'}`,
                text: `Total: ${passed + failed} tests\nPassed: ${passed}\nFailed: ${failed}`,
              },
            });
